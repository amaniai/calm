{"status":{},"contains_secrets":false,"product_version":"3.0.0.1","spec":{"description":"**HYCU Dashboard:** https:\/\/@@{HYCU_IP}@@:8443\/","resources":{"client_attrs":{"CentosDeployment":{"y":2,"x":107}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CentosDeploymentService"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"add_vm_to_hycu"}],"name":"CentosDeployment___create___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"CentosDeploymentService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"add_vm_to_hycu","attrs":{"script":"#script\n\n# Task name: Add a VM to HYCU backup group\n# Description:  The propose of this script is to add the current VM to HYCU backup group for\n#               for self-service setup. We assume the name of the group name in HYCU is the same\n#               as the Calm project name.\n#\n# Required Calm variables: \n#   HYCU_IP: IP address of HYCU VM\n#   HYCU: credentials object with premission to change VM ownership\n# Version: v1.0\n# Author: Husain Ebrahim <husain.ebrahim@nutanix.com>\n\n\n# HYCU API call function\n# ================================================================\ndef http_request(api_endpoint, payload='', method='POST'):\n  username = '@@{HYCU.username}@@'\n  password = '@@{HYCU.secret}@@'\n  hycu_ip = '@@{HYCU_IP}@@'\n  hycu_port = '8443'\n\n  url = \"https:\/\/{}:{}\/rest\/v1.0\/{}\".format(\n      hycu_ip,\n      hycu_port,\n      api_endpoint\n  )\n\n  headers = {\n      'Content-Type': 'application\/json',\n      'Accept': 'application\/json'\n  }\n\n  if len(payload) > 0:\n      payload = json.dumps(payload)\n\n\n  resp = urlreq(\n      url,\n      verb=method,\n      params=payload,\n      headers=headers,\n      auth='BASIC',\n      user=username,\n      passwd=password,\n      verify=False\n  )\n\n  if resp.ok:\n      return json.loads(resp.content), resp.ok\n  else:\n      print('Error in API call')\n      print(resp)\n      print(resp.content)\n      return None, None\n\ndef find_vm_hycu_uuid(uuid):\n    '''\n        Find the HYCU UUID of the target VM by searching for AHV UUID\n    '''\n    vm_list, status = http_request('vms', method='GET')\n\n    if not status:\n        print('Error in UUID search API call')\n        exit(1)\n\n    for vm in vm_list['entities']:\n        if vm['externalId'] == uuid:\n            return vm['uuid']\n    \n\ndef find_group_uuid(name):\n    '''\n        Find the uuid of the tenant group in HYCU, assuming same name as Calm project\n    '''\n    group_list, status = http_request('usergroups', method='GET')\n\n    if not status:\n        print('Error in find group uuid API call')\n        exit(1)\n\n    for group in group_list['entities']:\n        if group['name'] == name:\n            return group['uuid']\n    \n\ndef update_hycu_vm_owner(group_uuid, vm_uuid):\n    '''\n        API call to update the VM ownership in HYCU\n    '''\n    endpoint = 'usergroups\/{}'.format(group_uuid)\n    payload = {\n        'assignVirtualMachineIdsList': [vm_uuid]\n    }\n    result, status = http_request(endpoint, payload=payload)\n    if not status:\n        print('Error in VM onwership update API call')\n        exit(1)\n    return result['message']\n\nahv_uuid = '@@{id}@@'\nproject_name = '@@{calm_project_name}@@'\n\n# delay 30sec\nprint('sleep for 30sec to sync VM uuid with HYCU')\nsleep(30)\nprint('woke up')\n\n# HYCU VM UUID\nhycu_uuid = find_vm_hycu_uuid(ahv_uuid)\nif not hycu_uuid:\n    print('Error: AHV UUID not found in HYCU, make sure PE is added as source in HYCU')\n    print('@@{id}@@')\n    exit(1)\nprint('VM UUID in HYCU: {}'.format(hycu_uuid))\n\n# HYCU Group UUID\ngroup_uuid = find_group_uuid(project_name)\nif not group_uuid:\n    print('Error: Group UUID not found in HYCU for same Calm project name')\n    exit(1)\nprint('Groupd UUID for {}: {}'.format(project_name, group_uuid))\n\n# update HYCU ownership\nresult = update_hycu_vm_owner(group_uuid, hycu_uuid)\nprint(result['titleDescription'])","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"CentosDeployment___create___runbook","main_task_local_reference":{"kind":"app_task","name":"CentosDeployment___create___dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CentosDeploymentService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_CentosDeploymentService_action_delete","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_CentosDeploymentService_action_delete","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_CentosDeploymentService_action_delete"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CentosDeploymentService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_CentosDeploymentService_action_start","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_CentosDeploymentService_action_start","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_CentosDeploymentService_action_start"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CentosDeploymentService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_CentosDeploymentService_action_stop","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_CentosDeploymentService_action_stop","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_CentosDeploymentService_action_stop"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CentosDeploymentService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_CentosDeploymentService_action_restart","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_CentosDeploymentService_action_restart","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_CentosDeploymentService_action_restart"},"variable_list":[]},"name":"action_restart"},{"description":"System action for deleting an application. Does not delete created VMs","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CentosDeploymentService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_CentosDeploymentService_action_soft_delete","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_CentosDeploymentService_action_soft_delete","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_CentosDeploymentService_action_soft_delete"},"variable_list":[]},"name":"action_soft_delete"}],"depends_on_list":[],"name":"CentosDeploymentService","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"CentosDeploymentSubstrate","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":false},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"@@{VM_NAME}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"Default","uuid":"943cc2ac-dace-41c1-809b-a4eedc8e6090"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":1,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nssh_pwauth: True\nusers: \n  - name: @@{CENTOS.username}@@\n    groups: \"users,wheel\"\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nchpasswd: \n  expire: False\n  list: |\n    root:@@{CENTOS.secret}@@\n    @@{CENTOS.username}@@:@@{CENTOS.secret}@@"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"1ab524b9-7df2-40b4-b1bc-220dc492478b","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS-8","uuid":"3d9367d4-e2f6-426a-9003-e36facdf853a"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"CENTOS"},{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"HYCU"}],"package_definition_list":[{"description":"","action_list":[],"type":"CUSTOM","service_local_reference_list":[{"kind":"app_service","name":"CentosDeploymentService"}],"name":"CentosDeploymentPackage","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CentosDeploymentService"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Update CentOS"}],"name":"CentosDeployment___install___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"CentosDeploymentService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Update CentOS","attrs":{"script":"echo \"hello world\"","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"CentosDeployment___install___runbook","main_task_local_reference":{"kind":"app_task","name":"CentosDeployment___install___dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CentosDeploymentService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Package_CentosDeploymentPackage_action_uninstall","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Package_CentosDeploymentPackage_action_uninstall","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Package_CentosDeploymentPackage_action_uninstall"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"CentosDeployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"CentosDeploymentPackage"}],"substrate_local_reference":{"kind":"app_substrate","name":"CentosDeploymentSubstrate"},"options":{"type":""},"variable_list":[],"description":""}],"description":"","action_list":[],"name":"HYCUCentOS8Profile","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"VM_NAME","value":"CentOS-VM","label":"VM Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"HYCU_IP","value":"10.38.4.21","label":"","attrs":{"type":""},"is_hidden":true}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CENTOS"},"type":"USER"},"name":"HYCUCentOS8"},"api_version":"3.0","metadata":{"last_update_time":"1595862151687597","kind":"blueprint","spec_version":8,"creation_time":"1595859235099419","name":"HYCUCentOS8"}}