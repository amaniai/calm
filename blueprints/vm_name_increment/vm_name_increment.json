{"status":{},"contains_secrets":false,"product_version":"3.2.0","spec":{"description":"CentOS 8.3 \n\nWeb UI access: https:\/\/@@{VM1.address}@@:9090\/\n","resources":{"client_attrs":{},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3bc436cc_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"13913215_runbook","main_task_local_reference":{"kind":"app_task","name":"3bc436cc_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"5252f4da_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"94b84d56_runbook","main_task_local_reference":{"kind":"app_task","name":"5252f4da_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"bfbad1e2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"26acebf0_runbook","main_task_local_reference":{"kind":"app_task","name":"bfbad1e2_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"66f94a6b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"12541aca_runbook","main_task_local_reference":{"kind":"app_task","name":"66f94a6b_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"51228512_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"bc5c30aa_runbook","main_task_local_reference":{"kind":"app_task","name":"51228512_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Service1","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"get_next_id"}],"name":"a7ae4dd8_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"get_next_id","attrs":{"exit_status":[],"script":"import requests\n\n# -------------- Test Environment ------------------\n# import urllib3\n# urllib3.disable_warnings()\n# authorization = 'Basic YWRtaW46bngyVGVjaDkxMSE='\n# url = 'https:\/\/10.38.17.73:9440\/api\/nutanix\/v3\/{}'\n# project_name = 'default'\n# app_type = 'WWW'\n\n\n# -------------- Calm Environment ------------------\nvm_uuid = \"@@{id}@@\"\nauthorization = 'Bearer @@{calm_jwt}@@'\nurl = 'https:\/\/127.0.0.1:9440\/api\/nutanix\/v3\/{}'\nproject_name = '@@{calm_project_name}@@'\napp_type = '@@{APP_TYPE}@@'\n\n\nkwargs = {\n    'verify': False,\n    'headers': {'Authorization': authorization}\n}\n\n\n# ----------------- search for VM names starting with Project_name+App_type -----------------\npayload = {\n    'kind': 'vm',\n    'filter': 'vm_name=={}.*'.format(project_name+app_type),\n    'sort_order': 'DESCENDING',\n    'sort_attribute': 'vm_name'\n}\nresp = requests.post(url.format('vms\/list'), json=payload, **kwargs)\nif resp.status_code == 200:\n    vm_list = resp.json()['entities']\n    print('INFO - Prism has: {} vms starting with {}'.format(len(vm_list), project_name+app_type))\n    if len(vm_list):\n        try:\n            vm_name = vm_list[0]['spec']['name']\n            current_count = int(vm_list[0]['spec']['name'][-3:])\n            print('INFO - last vm unique count: {}'.format(current_count))\n            print('VM_ID={0:0=3d}'.format(current_count + 1))\n            exit(0)\n        except Exception as error:\n            print('ERROR - Last VM name does not match the expected pattern, vm name: {}'.format(vm_name))\n            print('ERROR - msg:{}'.format(error))\nelse:\n    print('ERROR - get vm api call failed, status code: {}'.format(resp.status_code))\n    print('ERROR - Msg: {}'.format(resp.content))\n\nprint('INFO - not able to get latest vm count, failing back to 001')\nprint('VM_ID=001')\n\n","eval_variables":["VM_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"d0e99c28_runbook","main_task_local_reference":{"kind":"app_task","name":"a7ae4dd8_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"46846143_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"027fef23_runbook","main_task_local_reference":{"kind":"app_task","name":"46846143_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"VM1","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":true,"login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"editables":{"create_spec":{"resources":{"nic_list":{"0":{"subnet_reference":true}},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"@@{calm_project_name}@@@@{APP_TYPE}@@@@{VM_ID}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"7e901527-da35-4ca1-a0fa-f471fee36efb"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":2,"gpu_list":[],"memory_size_mib":8192,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nssh_pwauth: True\nchpasswd:\n  list: |\n     @@{CENTOS.username}@@:@@{CENTOS.secret}@@\n     @@{USERNAME}@@:@@{PASSWORD}@@\n  expire: False\nusers:\n  - name: centos\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    shell: \/bin\/bash\n    groups: wheel\n  - name: @@{USERNAME}@@\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    shell: \/bin\/bash\n    groups: wheel"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"df16dfae-f333-4a15-a54b-d4f51ae47dd1","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"centos-8.3","uuid":"c47736a6-1fc9-4c09-bab7-266c0d1a9464"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"CENTOS"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Service1"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"enable_web_ui"}],"name":"bd92bd7c_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"enable_web_ui","attrs":{"exit_status":[],"script":"sudo systemctl enable --now cockpit.socket\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"91f61c51_runbook","main_task_local_reference":{"kind":"app_task","name":"bd92bd7c_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a1e3ddb7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"420a4f1f_runbook","main_task_local_reference":{"kind":"app_task","name":"a1e3ddb7_dag"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"fbfd3b05_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM1"},"variable_list":[],"description":""}],"environment_reference_list":[],"description":"","action_list":[],"name":"Default","variable_list":[{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"APP_TYPE","value":"APP","label":"Application Type","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["APP","SQL","WWW"]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"SECRET","name":"PASSWORD","value":"","label":"Password","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":true,"value":"^[a-z_]([a-z0-9_-]{0,31}|[a-z0-9_-]{0,30}\\$)$"},"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"USERNAME","value":"user","label":"CentOS Root User","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CENTOS"},"type":"USER"},"name":"vm_name_increment"},"api_version":"3.0","metadata":{"last_update_time":"1616258109246139","kind":"blueprint","spec_version":9,"creation_time":"1616252054773170","categories":{"TemplateType":"Vm"},"name":"vm_name_increment"}}